% FIXME: Use different S-expr parsing library that doesn't use character codes
:- set_prolog_flag(double_quotes, chars).

%:- use_module(library(assoc)).
%:- use_module('sexpr-3.6.7.pl').
%
%main :-
%    run(S), portray_clause(S).
%
%run(S) :-
%    string_codes("(* 2 (+ 3 4))", C),
%    codes_sexpr(C, S).

%% Grammar %%%%%%%%%%%%%%%

ffmpeg_plan(Plan) --> "ffmpeg", steps(Plan).
steps([]) --> "".
steps([H|T]) --> step(H), steps(T).
step(input_file(FileNameAtom)) -->
    {
        atom_chars(FileNameAtom, FileNameChars)
    },
    ws, "-i", ws, FileNameChars.
step(set_mapping(automatic)) --> "".
step(use_codec(Type, Codec)) -->
    {
        valid_codec(Type, TypeChars, Codec, CodecChars)
    },
    ws, "-c:", TypeChars, ws, CodecChars.
step(output_file(FileNameAtom)) -->
    {
        atom_chars(FileNameAtom, FileNameChars)
    },
    ws, "-o", ws, FileNameChars.

ws --> " ".

valid_codec(TypeAtom, TypeChars, CodecAtom, CodecChars) :-
    valid_codec_aux(TypeAtom, CodecAtom),
    atom_chars(TypeAtom, TypeChars),
    atom_chars(CodecAtom, CodecChars).
valid_codec_aux(audio, C) :- member(C, [aac, opus]).
valid_codec_aux(video, C) :- member(C, [libx264, libx265]).

%% Main %%%%%%%%%%%%%%%%%

main :-
    main(A),
    format("~s~n", [A]).

main(A) :-
    plan(P),
    phrase(ffmpeg_plan(P), A).

plan([
    input_file('world.mkv'),
    set_mapping(automatic),
    use_codec(video, libx265),
    use_codec(audio, opus),
    output_file('hello.mp4')
]).

sexpr_list_term(Lists, Terms) :-
    maplist(=.., Terms, Lists).

%% Utils %%%%%%%%%%%%%%%%%%

any_sequence([]) --> [].
any_sequence([H|T]) --> [H], any_sequence(T).

any_sequence_of_any_sequences([]) --> [].
any_sequence_of_any_sequences([H|T]) --> any_sequence(H), any_sequence_of_any_sequences(T).

concatenation(ListOfLists, Concatenation) :-
    phrase(any_sequence_of_any_sequences(ListOfLists), Concatenation).
